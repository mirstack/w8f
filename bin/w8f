#!/bin/bash

VERSION="0.1.0"
FILE=
BASENAME=
DIRNAME=
TIMEOUT=10
INTERVAL=1
OUTPUT=/dev/stdout

usage()
{
    cat <<EOF
Usage:

  w8f [-h] [-i INTERVAL] [-t TIMEOUT] [-v] FILE

Waits TIMEOUT number of seconds for file FILE to appear. If file exits or
appears then it exits with success, otherwise fails after TIMEOUT is exceeded.
Program checks for file existance every INTERVAL seconds.

Options:

  -h           Display this help dialog.
  -i INTERVAL  Number of seconds between which program will run checks.
               Default: 1.
  -t TIMEOUT   Maximum execution time. If 0, then no timeout.
               Default: 10.
  -v           Print current version.

For more information check 'man w8f'.
EOF
}

init()
{
    while getopts "hi:t:v" OPTION; do
        case $OPTION in
            h)
                usage
                exit 0
                ;;
            v)
                echo $VERSION
                exit 0
                ;;
            i)
                INTERVAL=$OPTARG
                ;;
            t)
                TIMEOUT=$OPTARG
                ;;
            ?|*)
                usage
                exit 1
                ;;
        esac
    done

    shift $(($OPTIND - 1))

    case $# in
        1)
            FILE=$1
            BASENAME=$(basename $FILE)
            DIRNAME=$(dirname $FILE)
            ;;
        *)
            echo "ERROR -- missing file name" >&2
            usage
            exit 1
            ;;
    esac
}

main()
{
    slept=0

    while [ ! -e $FILE ]; do
        sleep $INTERVAL
        slept=$(( slept + INTERVAL ))

        if (( $TIMEOUT > 0 )) && (( $slept >= $TIMEOUT )); then
            echo "ERROR -- timed out!" >&2
            exit 1
        fi
    done

    exit 0
}

init "$@" && main
